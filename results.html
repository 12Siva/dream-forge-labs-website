<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weaving Your Story... | Dream Forge Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Exo 2', sans-serif;
            background-color: #F9FAFB;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background: #111827;
        }
        ::selection {
            background-color: #F97316;
            color: #ffffff;
        }
        .dark ::selection {
            color: #111827;
        }
    </style>
    <script>
        // Set theme on initial load to prevent Flash of Unstyled Content (FOUC)
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="antialiased text-gray-800 dark:text-gray-300">

    <main class="container mx-auto px-6 py-16">
        <div id="status-display" class="max-w-3xl mx-auto text-center" role="status" aria-live="polite">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-gray-50 mb-8">
                Weaving your new adventure...
            </h1>
            <div id="status-box" class="bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 p-4 rounded-lg flex items-center justify-center shadow-md">
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="status-text">Our storytellers are hard at work. This can take a minute or two. Please wait...</span>
            </div>
        </div>

        <div id="story-container" class="max-w-4xl mx-auto hidden">
             <div class="bg-white dark:bg-gray-900/50 p-8 md:p-12 rounded-xl shadow-lg border border-gray-200 dark:border-gray-800">
                <div id="story-output" class="prose dark:prose-invert max-w-none prose-p:text-lg prose-p:leading-relaxed">
                    </div>
                 <div class="text-center mt-12">
                     <a href="app.html" class="bg-[#F97316] hover:bg-[#EA580C] text-white font-bold py-3 px-8 rounded-lg text-lg transition-all duration-300 transform hover:scale-105 shadow-lg shadow-orange-500/20 hover:shadow-xl hover:shadow-orange-500/30">
                        Weave Another Story
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Configuration & DOM Elements ---
        const API_BASE_URL = 'https://507041jst3.execute-api.us-east-2.amazonaws.com';
        const statusDisplay = document.getElementById('status-display');
        const statusBox = document.getElementById('status-box');
        const spinner = document.getElementById('spinner');
        const statusText = document.getElementById('status-text');
        const storyContainer = document.getElementById('story-container');
        const storyOutput = document.getElementById('story-output');

        /**
         * Fetches the story content from the API.
         * @param {string} key - The key of the story file to fetch.
         * @param {AbortSignal} signal - The signal to abort the fetch request.
         * @returns {Promise<string|null>} The story text or null if not found or an error occurred.
         */
        async function getStory(key, signal) {
            try {
                const response = await fetch(`${API_BASE_URL}/get-story?key=${encodeURIComponent(key)}`, { signal });
                if (response.ok) {
                    const data = await response.json();
                    return data.story;
                }
                // Return null for 404 (still generating) or other server errors to allow for retries.
                return null;
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error("Error fetching story:", error);
                }
                return null;
            }
        }

        /**
         * Displays the fetched story in a simple, readable format.
         * @param {string} storyText - The raw text of the story.
         */
        function displayStory(storyText) {
            // Set the page title
            document.title = 'Your New Story | Dream Forge Labs';

            // Hide the status indicator and show the story container
            statusDisplay.classList.add('hidden');
            storyContainer.classList.remove('hidden');

            // Sanitize and format the story text into HTML paragraphs
            const formattedStory = storyText
                .replace(/\\n/g, '\n') // Replace literal '\n' with newlines
                .split('\n')          // Split text into an array of lines
                .filter(p => p.trim() !== '') // Remove any empty lines
                .map(p => `<p>${p.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>`) // Wrap each line in a <p> tag and escape HTML
                .join('');

            // Inject the formatted HTML into the output element
            storyOutput.innerHTML = formattedStory;
        }

        /**
         * Shows an error message if the story fails to load after multiple attempts.
         */
        function showTimeoutError() {
            document.title = 'Story Timed Out | Dream Forge Labs';
            if (spinner) spinner.style.display = 'none';
            statusText.textContent = 'Sorry, the story is taking longer than expected to create.';

            // Change status box color to indicate an error
            statusBox.classList.remove('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-800', 'dark:text-blue-300');
            statusBox.classList.add('bg-red-100', 'dark:bg-red-900/30', 'text-red-800', 'dark:text-red-300');

            // Add a "Try Again" button that links back to the app page
            const tryAgainButton = document.createElement('a');
            tryAgainButton.href = 'app.html';
            tryAgainButton.className = 'bg-[#F97316] hover:bg-[#EA580C] text-white font-bold py-2 px-4 rounded-lg text-md transition-all duration-300 ml-4';
            tryAgainButton.textContent = 'Try Again';
            statusBox.appendChild(tryAgainButton);
        }

        // --- Main Execution Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const originalFileName = params.get('fileName');

            if (!originalFileName) {
                statusText.textContent = 'Error: No story specified.';
                showTimeoutError(); // Use the error display for consistency
                return;
            }

            // The key for the rewritten story is the original filename with a new extension
            const rewrittenStoryKey = originalFileName.replace(/\.[^/.]+$/, "") + ".rewritten.txt";

            // Poll for the story with exponential backoff
            let attempts = 0;
            const maxAttempts = 12; // About 5 minutes total polling time
            let delay = 5000;       // Start with a 5-second delay
            let stopped = false;

            // Abort fetch requests if the user navigates away
            const controller = new AbortController();
            window.addEventListener('beforeunload', () => {
                stopped = true;
                controller.abort();
            });

            (async function pollForStory() {
                while (!stopped && attempts < maxAttempts) {
                    attempts++;
                    const story = await getStory(rewrittenStoryKey, controller.signal);

                    if (story) {
                        displayStory(story);
                        return; // Success! Exit the loop.
                    }

                    // Wait for the next attempt
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay = Math.min(delay * 1.5, 30000); // Increase delay, maxing out at 30s
                }

                // If the loop finishes without success, show the timeout error
                if (!stopped) {
                    showTimeoutError();
                    console.error("Max polling attempts reached. Stopping.");
                }
            })();
        });
    </script>

</body>
</html>
