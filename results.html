<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weaving Your Story... | Dream Forge Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700;800;9.0&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Exo 2', sans-serif;
            background-color: #F9FAFB;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background: #111827;
        }
        ::selection {
            background-color: #F97316;
            color: #ffffff;
        }
        .dark ::selection {
            color: #111827;
        }
        /* Style for the horizontal rule page break */
        .page-break {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(249, 115, 22, 0.75), rgba(0, 0, 0, 0));
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .dark .page-break {
             background-image: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(249, 115, 22, 0.6), rgba(255, 255, 255, 0));
        }
    </style>
    <script>
        // Set theme on initial load to prevent Flash of Unstyled Content (FOUC)
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="antialiased text-gray-800 dark:text-gray-300">

    <main class="container mx-auto px-6 py-16">
        <div id="status-display" class="max-w-3xl mx-auto text-center" role="status" aria-live="polite">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-gray-50 mb-8">
                Weaving your new adventure...
            </h1>
            <div id="status-box" class="bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 p-4 rounded-lg flex items-center justify-center shadow-md">
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="status-text">Our storytellers are hard at work. This can take a minute or two. Please wait...</span>
            </div>
        </div>

        <div id="story-container" class="max-w-4xl mx-auto hidden">
             <div class="bg-white dark:bg-gray-900/50 p-8 md:p-12 rounded-xl shadow-lg border border-gray-200 dark:border-gray-800">
                <div id="story-output" class="prose dark:prose-invert max-w-none prose-lg prose-p:leading-relaxed">
                    </div>
                 <div class="text-center mt-12">
                     <a href="app.html" class="bg-[#F97316] hover:bg-[#EA580C] text-white font-bold py-3 px-8 rounded-lg text-lg transition-all duration-300 transform hover:scale-105 shadow-lg shadow-orange-500/20 hover:shadow-xl hover:shadow-orange-500/30">
                        Weave Another Story
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Configuration & DOM Elements ---
        const API_BASE_URL = 'https://507041jst3.execute-api.us-east-2.amazonaws.com';
        const statusDisplay = document.getElementById('status-display');
        const statusBox = document.getElementById('status-box');
        const spinner = document.getElementById('spinner');
        const statusText = document.getElementById('status-text');
        const storyContainer = document.getElementById('story-container');
        const storyOutput = document.getElementById('story-output');

        async function getStory(key, signal) {
            try {
                const response = await fetch(`${API_BASE_URL}/get-story?key=${encodeURIComponent(key)}`, { signal });
                if (response.ok) {
                    const data = await response.json();
                    return data.story;
                }
                return null;
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error("Error fetching story:", error);
                }
                return null;
            }
        }

        /**
         * Displays the story, breaking it up with horizontal lines for readability.
         * @param {string} storyText - The raw text of the story.
         */
        function displayStory(storyText) {
            document.title = 'Your New Story | Dream Forge Labs';
            statusDisplay.classList.add('hidden');
            storyContainer.classList.remove('hidden');

            const paragraphs = storyText
                .replace(/\\n/g, '\n')
                .split('\n')
                .filter(p => p.trim() !== '');

            let finalHtml = '';
            const breakInterval = 4; // Add a line break every 4 paragraphs

            paragraphs.forEach((p, index) => {
                finalHtml += `<p>${p.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>`;

                // Add a horizontal rule after every `breakInterval` paragraphs, but not after the last one.
                if ((index + 1) % breakInterval === 0 && (index + 1) < paragraphs.length) {
                    finalHtml += `<hr class="page-break">`;
                }
            });

            storyOutput.innerHTML = finalHtml;
        }

        function showTimeoutError() {
            document.title = 'Story Timed Out | Dream Forge Labs';
            if (spinner) spinner.style.display = 'none';
            statusText.textContent = 'Sorry, the story is taking longer than expected to create.';

            statusBox.classList.remove('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-800', 'dark:text-blue-300');
            statusBox.classList.add('bg-red-100', 'dark:bg-red-900/30', 'text-red-800', 'dark:text-red-300');

            const tryAgainButton = document.createElement('a');
            tryAgainButton.href = 'app.html';
            tryAgainButton.className = 'bg-[#F97316] hover:bg-[#EA580C] text-white font-bold py-2 px-4 rounded-lg text-md transition-all duration-300 ml-4';
            tryAgainButton.textContent = 'Try Again';
            statusBox.appendChild(tryAgainButton);
        }

        // --- Main Execution Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const originalFileName = params.get('fileName');

            if (!originalFileName) {
                statusText.textContent = 'Error: No story specified.';
                showTimeoutError();
                return;
            }

            const rewrittenStoryKey = originalFileName.replace(/\.[^/.]+$/, "") + ".rewritten.txt";

            let attempts = 0;
            const maxAttempts = 12;
            let delay = 5000;
            let stopped = false;

            const controller = new AbortController();
            window.addEventListener('beforeunload', () => {
                stopped = true;
                controller.abort();
            });

            (async function pollForStory() {
                while (!stopped && attempts < maxAttempts) {
                    attempts++;
                    const story = await getStory(rewrittenStoryKey, controller.signal);

                    if (story) {
                        displayStory(story);
                        return;
                    }

                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay = Math.min(delay * 1.5, 30000);
                }

                if (!stopped) {
                    showTimeoutError();
                    console.error("Max polling attempts reached. Stopping.");
                }
            })();
        });
    </script>

</body>
</html>
