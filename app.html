<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryWeaver App - Dream Forge Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            plugins: [
                require('@tailwindcss/typography'),
            ],
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Exo 2', sans-serif; 
            background-color: #F9FAFB; 
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body { 
            background: #111827; 
        }
        ::selection { 
            background-color: #F97316; 
            color: #ffffff; 
        }
        .dark ::selection { 
            color: #111827; 
        }
    </style>
    <script>
        // Set theme on initial load to prevent Flash of Unstyled Content (FOUC)
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="antialiased text-gray-800 dark:text-gray-300">

    <!-- Header -->
    <header class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700">
        <div class="container mx-auto px-6 py-4">
            <nav class="flex items-center justify-between">
                <a href="index.html" class="text-2xl font-bold text-gray-900 dark:text-gray-50 flex items-center">
                    <i class="fas fa-film mr-2 text-[#F97316]"></i> Dream Forge Labs
                </a>
                <div class="flex items-center space-x-4">
                    <a href="index.html#storyweaver" class="hidden md:block text-gray-600 dark:text-gray-300 hover:text-[#F97316] dark:hover:text-[#F97316] transition-colors">Back to Home</a>
                    <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 hover:text-[#F97316] dark:hover:text-[#F97316] transition-colors w-10 h-10 flex items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
                        <i class="fas fa-moon text-xl hidden" id="theme-toggle-dark-icon"></i>
                        <i class="fas fa-sun text-xl hidden" id="theme-toggle-light-icon"></i>
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main App Content -->
    <main class="container mx-auto px-6 py-16">
        <div class="max-w-3xl mx-auto text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-gray-50 mb-4">Create Your Story</h1>
            <p class="text-lg text-gray-600 dark:text-gray-300">Upload a story in PDF format, give us a "what if" prompt, and watch the magic happen.</p>
        </div>

        <div class="max-w-2xl mx-auto mt-12 bg-white dark:bg-gray-900/50 p-8 rounded-xl shadow-lg border border-gray-200 dark:border-gray-800">
            <form id="story-form" autocomplete="off">
                <div class="space-y-6">
                    <!-- File Upload -->
                    <div>
                        <label for="pdf-file" class="block text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2">1. Upload Your Story (PDF)</label>
                        <input type="file" id="pdf-file" name="pdf-file" accept=".pdf" required class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-[#F97316]/10 file:text-[#F97316] hover:file:bg-[#F97316]/20 dark:file:bg-gray-700 dark:file:text-gray-300 dark:hover:file:bg-gray-600 cursor-pointer"/>
                    </div>

                    <!-- What If Prompt -->
                    <div>
                        <label for="user-prompt" class="block text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2">2. Ask "What If?"</label>
                        <textarea id="user-prompt" name="user-prompt" rows="3" required placeholder="e.g., What if the wolf was friendly and just wanted to bake cookies?" class="w-full px-4 py-2 text-gray-700 bg-gray-100 dark:bg-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-[#F97316] focus:border-transparent transition"></textarea>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="mt-8 text-center">
                    <button type="submit" id="submit-button" class="bg-[#F97316] hover:bg-[#EA580C] text-white font-bold py-3 px-8 rounded-lg text-lg transition-all duration-300 w-full md:w-auto shadow-lg shadow-orange-500/20 hover:shadow-xl hover:shadow-orange-500/30">
                        Weave My Story!
                    </button>
                </div>
            </form>
        </div>

        <!-- Status & Results Section -->
        <div id="results-section" class="max-w-4xl mx-auto mt-12 hidden">
            <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-gray-50 mb-8">Your New Story</h2>
            
            <!-- Status Display -->
            <div id="status-display" class="bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 p-4 rounded-lg text-center mb-8 flex items-center justify-center">
                <i class="fas fa-spinner fa-spin mr-3"></i>
                <span id="status-text">Processing your request...</span>
            </div>

            <!-- Story Output -->
            <div id="story-output" class="bg-white dark:bg-gray-900/50 p-8 rounded-xl shadow-lg border border-gray-200 dark:border-gray-800 hidden prose dark:prose-invert max-w-none leading-relaxed">
                <!-- The rewritten story will be injected here -->
            </div>
        </div>
    </main>

    <script>
        // --- FORM RESET ON PAGE LOAD (IMPROVED) ---
        window.addEventListener('pageshow', () => {
            const form = document.getElementById('story-form');
            if (form) {
                form.reset();
            }
        });

        // --- API Configuration ---
        // IMPORTANT: Replace this placeholder URL with your actual API Gateway Invoke URL.
        const API_BASE_URL = 'https://507041jst3.execute-api.us-east-2.amazonaws.com'; // Use the single Invoke URL from your "Story Weaver Upload API"

        // --- DOM Elements ---
        const storyForm = document.getElementById('story-form');
        const submitButton = document.getElementById('submit-button');
        const resultsSection = document.getElementById('results-section');
        const statusDisplay = document.getElementById('status-display');
        const statusText = document.getElementById('status-text');
        const storyOutput = document.getElementById('story-output');

        // --- Form Submission Handler ---
        storyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const pdfFile = document.getElementById('pdf-file').files[0];
            const userPrompt = document.getElementById('user-prompt').value;

            if (!pdfFile || !userPrompt) {
                alert('Please provide both a PDF file and a prompt.');
                return;
            }

            // --- Start the process ---
            setLoading(true, 'Starting the magic...');
            
            try {
                // 1. Get a secure URL to upload the file
                setStatus('1/4: Getting upload permission...');
                const uploadConfig = await getUploadUrl(pdfFile.name);

                // 2. Upload the PDF file directly to S3
                setStatus('2/4: Uploading your story...');
                await uploadFile(pdfFile, uploadConfig.uploadURL);
                
                // 3. Wait for text extraction
                setStatus('3/4: Analyzing story structure...');
                await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10s for text extraction

                // The key for the text file is the PDF filename with a .txt extension
                const sourceKey = pdfFile.name.replace(/\.[^/.]+$/, "") + ".txt";

                // 4. Call the second Lambda to rewrite the story
                setStatus('4/4: Weaving your new tale...');
                rewriteStory(sourceKey, userPrompt);
                
                // 5. Immediately redirect to the results page
                window.location.href = `results.html?fileName=${encodeURIComponent(pdfFile.name)}`;


            } catch (error) {
                console.error('An error occurred:', error);
                setStatus(`Error: ${error.message}`, true);
                setLoading(false);
            }
        });

        // --- Helper Functions (IMPROVED WITH CORS MODE) ---

        async function getUploadUrl(fileName) {
            const response = await fetch(`${API_BASE_URL}/generate-upload-url?fileName=${encodeURIComponent(fileName)}`, {
                method: 'GET',
                mode: 'cors'
            });
            if (!response.ok) throw new Error('Could not get upload URL. Please verify API Gateway CORS configuration and wait a few minutes for changes to deploy.');
            return response.json();
        }

        async function uploadFile(file, uploadUrl) {
            const response = await fetch(uploadUrl, {
                method: 'PUT',
                body: file,
                headers: { 
                    'Content-Type': 'application/pdf'
                },
                mode: 'cors'
            });
            if (!response.ok) throw new Error('File upload to S3 failed. Please verify S3 CORS configuration.');
        }

        async function rewriteStory(sourceKey, userPrompt) {
            const response = await fetch(`${API_BASE_URL}/rewrite-story`, {
                method: 'POST',
                body: JSON.stringify({ sourceKey, userPrompt }),
                headers: { 'Content-Type': 'application/json' },
                mode: 'cors'
            });
            if (!response.ok) throw new Error('Failed to rewrite the story. Please verify API Gateway CORS configuration for the POST route.');
            return response.json();
        }

        function displayStory(storyText) {
            // Convert newlines to paragraphs for better display
            const formattedStory = storyText.split('\n').filter(p => p.trim() !== '').map(p => `<p class="mb-4">${p}</p>`).join('');
            storyOutput.innerHTML = formattedStory;
            storyOutput.classList.remove('hidden');
            statusDisplay.classList.add('hidden');
        }

        function setLoading(isLoading, initialText = '') {
            if (isLoading) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Working...';
                resultsSection.classList.remove('hidden');
                storyOutput.classList.add('hidden');
                statusDisplay.classList.remove('hidden');
                statusDisplay.className = 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 p-4 rounded-lg text-center mb-8 flex items-center justify-center';
                if(initialText) setStatus(initialText);
            } else {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Weave Another Story!';
            }
        }
        
        function setStatus(text, isError = false) {
            statusText.textContent = text;
            if(isError) {
                statusDisplay.classList.replace('bg-blue-100', 'bg-red-100');
                statusDisplay.classList.replace('dark:bg-blue-900/30', 'dark:bg-red-900/30');
                statusDisplay.classList.replace('text-blue-800', 'text-red-800');
                statusDisplay.classList.replace('dark:text-blue-300', 'dark:text-red-300');
            }
        }

        // --- Theme Toggle Script ---
        const themeToggleButton = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const setTheme = (isDark) => {
            if (isDark) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            }
        };
        setTheme(document.documentElement.classList.contains('dark'));
        themeToggleButton.addEventListener('click', () => {
            setTheme(!document.documentElement.classList.contains('dark'));
        });
    </script>

</body>
</html>

