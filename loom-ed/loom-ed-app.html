<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoomEd App - Dream Forge Labs</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    // This is the color palette you liked from the original file
                    colors: {
                        'deep-purple': '#6B4FBF',
                        'warm-cream': '#FFF8E7',
                        'coral-pink': '#FF7B68',
                        'ocean-teal': '#2DBFB8',
                        'golden-yellow': '#FFB84D',
                        'forest-green': '#4A7C59',
                        'slate-gray': '#6B7280',
                        'soft-red': '#E86C6C',
                        'charcoal': '#2D3748',
                        'medium-purple': '#8B7AB8',
                    },
                    fontFamily: {
                        display: ['Fredoka', 'sans-serif'],
                        body: ['Lexend', 'sans-serif'],
                        ui: ['Inter', 'sans-serif'],
                    }
                }
            },
            // Add the typography plugin for styling the story text
            plugins: [
                require('@tailwindcss/typography'),
            ],
        }
    </script>
    
    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600&family=Inter:wght@400;500&family=Lexend:wght@400&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* This is the "yellow background" you liked */
            background-color: #FFF8E7; /* Warm Cream */
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #2D3748; /* Charcoal */
        }
        ::selection {
            background-color: #6B4FBF; /* Deep Purple */
            color: #ffffff;
        }
        .dark ::selection {
            background-color: #FFB84D; /* Golden Yellow */
            color: #1a202c;
        }
        /* Class for highlighted text */
        .highlight {
            background-color: #FFB84D; /* Golden Yellow */
            cursor: pointer;
            border-radius: 3px;
            padding: 2px 1px;
        }
        .dark .highlight {
            background-color: #6B4FBF; /* Deep Purple */
        }
    </style>
    
    <!-- Theme Flicker Prevention -->
    <script>
        // Set theme on initial load to prevent FOUC (Flash of Unstyled Content)
        if (localStorage.getItem('theme') === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="antialiased font-ui text-charcoal dark:text-warm-cream">

    <!-- Header -->
    <header class="bg-warm-cream/80 dark:bg-charcoal/80 backdrop-blur-md sticky top-0 z-50 border-b border-medium-purple dark:border-deep-purple">
        <div class="container mx-auto px-6 py-4">
            <nav class="flex items-center justify-between">
                <!-- App Title/Logo -->
                <a href="../index.html" class="text-2xl font-display font-semibold text-deep-purple dark:text-warm-cream flex items-center">
                    <i class="fas fa-book-reader mr-2"></i> LoomEd
                </a>
                
                <!-- Navigation Links -->
                <div class="flex items-center space-x-4">
                    <a href="../index.html#loom-ed" class="hidden md:block text-medium-purple dark:text-warm-cream hover:text-deep-purple dark:hover:text-deep-purple transition-colors">
                        Back to Home
                    </a>
                    <!-- Theme Toggle Button -->
                    <button id="theme-toggle" class="text-medium-purple dark:text-warm-cream hover:text-deep-purple dark:hover:text-deep-purple transition-colors w-10 h-10 flex items-center justify-center rounded-lg hover:bg-warm-cream dark:hover:bg-charcoal">
                        <i class="fas fa-moon text-xl hidden" id="theme-toggle-dark-icon"></i>
                        <i class="fas fa-sun text-xl hidden" id="theme-toggle-light-icon"></i>
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main App Content -->
    <main class="container mx-auto px-6 py-8">
        <div class="flex flex-col md:flex-row gap-8">

            <!-- Sidebar: Story List -->
            <aside class="w-full md:w-1/4">
                <div class="bg-white dark:bg-charcoal/50 p-6 rounded-xl shadow-lg border border-medium-purple dark:border-deep-purple">
                    <h2 class="text-2xl font-display font-bold text-deep-purple dark:text-warm-cream mb-4">
                        Short Stories
                    </h2>
                    <!-- Story list content will be injected by JavaScript -->
                    <div id="story-list" class="space-y-2">
                        <!-- Loading state or error state will appear here -->
                    </div>
                </div>
            </aside>

            <!-- Main Content: Reader Area -->
            <section class="w-full md:w-3/4">
                <div id="story-content-area" class="bg-white dark:bg-charcoal/50 p-8 rounded-xl shadow-lg border border-medium-purple dark:border-deep-purple min-h-[60vh] flex flex-col justify-center">
                    
                    <!-- Welcome/Placeholder Message -->
                    <div id="story-placeholder" class="text-center text-slate-gray dark:text-gray-400">
                        <i class="fas fa-book-open text-6xl text-medium-purple dark:text-gray-500 mb-6"></i>
                        <h3 class="text-2xl font-display font-semibold text-charcoal dark:text-warm-cream mb-2">
                            Welcome to LoomEd!
                        </h3>
                        <p class="text-lg">
                            Ready for an adventure? Pick a story from the sidebar on the left to begin reading.
                        </p>
                    </div>

                    <!-- Story Text (hidden by default) -->
                    <div id="story-text" class="hidden prose dark:prose-invert max-w-none prose-lg prose-p:leading-relaxed">
                        <!-- Story paragraphs will be injected here -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Pop-up for Highlighting and Notes -->
    <div id="tooltip" class="hidden absolute bg-charcoal dark:bg-warm-cream text-white dark:text-charcoal p-2 rounded-lg shadow-xl z-50 space-x-1">
        <button id="highlight-btn" class="px-3 py-1 hover:bg-deep-purple dark:hover:bg-golden-yellow rounded transition-colors">
            <i class="fas fa-highlighter mr-1"></i> Highlight
        </button>
        <button id="note-btn" class="px-3 py-1 hover:bg-deep-purple dark:hover:bg-golden-yellow rounded transition-colors">
            <i class="fas fa-note-sticky mr-1"></i> Take Note
        </button>
    </div>

    <!-- Main Application Logic -->
    <script>
        // --- Configuration ---
        // This is the API endpoint from your original file.
        // If it's wrong, you will still get a network error, but the "Retry" button will work.
        const API_BASE_URL = 'https://dgv9q2uuuf.execute-api.us-east-2.amazonaws.com/Prod/';

        // --- DOM Elements ---
        const storyListContainer = document.getElementById('story-list');
        const storyContentArea = document.getElementById('story-content-area');
        const storyPlaceholder = document.getElementById('story-placeholder');
        const storyTextContainer = document.getElementById('story-text');
        const tooltip = document.getElementById('tooltip');
        const highlightBtn = document.getElementById('highlight-btn');
        const noteBtn = document.getElementById('note-btn');

        let selectedRange = null;
        let activeStoryButton = null;

        // --- Core Functions ---

        /**
         * Shows a skeleton loading animation in the story list.
         */
        function showLoadingState() {
            storyListContainer.innerHTML = `
                <div class="space-y-3">
                    <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-3/4 animate-pulse"></div>
                    <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-5/6 animate-pulse"></div>
                    <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/2 animate-pulse"></div>
                </div>
            `;
        }

        /**
         * Shows a robust error message with a retry button.
         * @param {string} errorMessage - The error message to display (e.g., from a network error).
         */
        function showErrorState(errorMessage) {
            storyListContainer.innerHTML = `
                <div class="text-center p-4 bg-soft-red/10 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-soft-red text-3xl mb-3"></i>
                    <p class="font-semibold text-soft-red mb-2">Failed to load stories.</p>
                    <p class="text-xs text-slate-gray dark:text-gray-400 mb-4">
                        Error: ${errorMessage}
                    </p>
                    <button id="retry-button" class="bg-deep-purple hover:bg-deep-purple/80 text-white dark:bg-golden-yellow dark:text-charcoal dark:hover:bg-golden-yellow/80 px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                        Retry
                    </button>
                </div>
            `;
        }

        /**
         * Fetches the list of stories from the API and displays them.
         */
        async function fetchStories() {
            showLoadingState();
            
            try {
                const response = await fetch(`${API_BASE_URL}/stories`);
                
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                
                const stories = await response.json();
                
                if (stories.length === 0) {
                     storyListContainer.innerHTML = `<p class="text-slate-gray dark:text-gray-400">No stories found.</p>`;
                     return;
                }
                
                displayStoryList(stories);

            } catch (error) {
                console.error('Error fetching stories:', error);
                // This is the new, improved error handling
                showErrorState(error.message);
            }
        }

        /**
         * Renders the list of stories as buttons in the sidebar.
         * @param {Array} stories - An array of story objects (e.g., [{id: 1, title: "..."}]).
         */
        function displayStoryList(stories) {
            storyListContainer.innerHTML = ''; // Clear loading state
            stories.forEach(story => {
                const button = document.createElement('button');
                button.className = 'block w-full text-left px-4 py-2 rounded-lg text-deep-purple dark:text-gray-300 hover:bg-warm-cream dark:hover:bg-charcoal/70 transition-colors';
                button.textContent = story.title;
                button.dataset.storyId = story.id; // Store story ID on the button
                
                button.addEventListener('click', () => {
                    // Remove active state from previous button
                    if (activeStoryButton) {
                        activeStoryButton.classList.remove('bg-warm-cream', 'dark:bg-charcoal/70', 'font-semibold');
                    }
                    // Add active state to current button
                    button.classList.add('bg-warm-cream', 'dark:bg-charcoal/70', 'font-semibold');
                    activeStoryButton = button;

                    fetchStoryContent(story.id);
                });
                
                storyListContainer.appendChild(button);
            });
        }

        /**
         * Fetches and displays the content for a specific story.
         * @param {string} storyId - The ID of the story to fetch.
         */
        async function fetchStoryContent(storyId) {
            try {
                // Show loading state in the main panel
                storyPlaceholder.classList.remove('hidden');
                storyPlaceholder.innerHTML = `
                    <i class="fas fa-spinner fa-spin text-6xl text-medium-purple dark:text-gray-500 mb-6"></i>
                    <p class="text-lg">Loading story...</p>
                `;
                storyTextContainer.classList.add('hidden');
                
                const response = await fetch(`${API_BASE_URL}/stories/${storyId}`);
                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                
                const story = await response.json();
                displayStoryContent(story.title, story.content);

            } catch (error) {
                console.error('Error fetching story content:', error);
                storyPlaceholder.innerHTML = `
                    <i class="fas fa-exclamation-circle text-6xl text-soft-red mb-6"></i>
                    <h3 class="text-2xl font-display font-semibold text-charcoal dark:text-warm-cream mb-2">
                        Could not load story
                    </h3>
                    <p class="text-lg text-slate-gray dark:text-gray-400">
                        ${error.message}
                    </p>
                `;
            }
        }

        /**
         * Displays the story text in the main content area.
         * @param {string} title - The story's title.
         * @param {string} content - The story's content (as a long string with \n).
         */
        function displayStoryContent(title, content) {
            storyPlaceholder.classList.add('hidden');
            storyTextContainer.classList.remove('hidden');
            
            // Format content: add title and convert newlines to paragraphs
            const paragraphs = content.split('\n').map(p => `<p>${p}</p>`).join('');
            storyTextContainer.innerHTML = `<h1>${title}</h1>${paragraphs}`;
        }
        
        // --- Event Listeners ---

        // 1. Initial page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchStories();
        });

        // 2. Retry Button (using event delegation)
        storyListContainer.addEventListener('click', (event) => {
            if (event.target && event.target.id === 'retry-button') {
                fetchStories(); // Re-run the fetch function
            }
        });

        // 3. Text Selection (Mouse Up)
        storyTextContainer.addEventListener('mouseup', (event) => {
            const selection = window.getSelection();
            if (selection.toString().trim().length > 0) {
                selectedRange = selection.getRangeAt(0);
                const rect = selectedRange.getBoundingClientRect();
                
                // Position tooltip above the selection
                tooltip.style.left = `${window.scrollX + rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
                tooltip.style.top = `${window.scrollY + rect.top - tooltip.offsetHeight - 10}px`;
                tooltip.classList.remove('hidden');
            } else {
                tooltip.classList.add('hidden');
            }
        });
        
        // 4. Clicking outside the tooltip/selection
        document.addEventListener('mousedown', (event) => {
             if (!tooltip.contains(event.target) && !storyTextContainer.contains(event.target)) {
                tooltip.classList.add('hidden');
                window.getSelection().removeAllRanges();
                selectedRange = null;
            }
        });

        // 5. Highlight Button Click
        highlightBtn.addEventListener('click', () => {
            if (selectedRange) {
                const span = document.createElement('span');
                span.className = 'highlight';
                
                // Add click-to-remove functionality to the highlight
                span.onclick = (e) => {
                     // Using a simple custom modal instead of confirm()
                     showModal('Remove this highlight?', () => {
                        const parent = e.target.parentNode;
                        while(e.target.firstChild) {
                            parent.insertBefore(e.target.firstChild, e.target);
                        }
                        parent.removeChild(e.target);
                        parent.normalize(); // Clean up empty text nodes
                     });
                };
                
                try {
                    // Wrap the selected content in the new span
                    span.appendChild(selectedRange.extractContents());
                    selectedRange.insertNode(span);
                } catch(e) {
                     console.error("Could not highlight this selection.", e);
                }
                
                // Clean up
                window.getSelection().removeAllRanges();
                tooltip.classList.add('hidden');
                selectedRange = null;
            }
        });

        // 6. Note Button Click
        noteBtn.addEventListener('click', () => {
            if (selectedRange) {
                // Using a simple custom modal instead of prompt()
                showPrompt('Enter your note:', (noteText) => {
                    if (noteText) {
                        // In a real app, you would save this to a database.
                        const highlightedText = selectedRange.toString();
                        console.log(`Note added for text: "${highlightedText}"\nNote: "${noteText}"`);
                        
                        // Show a confirmation toast
                        showToast('Note saved! (Check the console)');
                    }
                    
                    // Clean up
                    window.getSelection().removeAllRanges();
                    tooltip.classList.add('hidden');
                    selectedRange = null;
                });
            }
        });

        // --- UI Helper Functions (Replaced alert/confirm/prompt) ---

        /**
         * Displays a simple toast message at the top of the screen.
         * @param {string} message - The message to display.
         */
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-5 right-5 bg-charcoal text-white px-5 py-3 rounded-lg shadow-xl z-[100] transition-all duration-300 translate-x-full opacity-0';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 10);
            
            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        /**
         * Displays a custom modal confirmation dialog.
         * @param {string} message - The question to ask.
         * @param {function} onConfirm - Callback function to run if "OK" is clicked.
         */
        function showModal(message, onConfirm) {
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'modal-overlay';
            modalOverlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[90] flex items-center justify-center';
            
            modalOverlay.innerHTML = `
                <div class="bg-white dark:bg-charcoal p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <p class="text-lg text-charcoal dark:text-warm-cream mb-6">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="modal-cancel" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancel</button>
                        <button id="modal-ok" class="px-4 py-2 rounded-lg bg-deep-purple text-white hover:bg-deep-purple/80 transition-colors">OK</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);

            document.getElementById('modal-ok').onclick = () => {
                onConfirm();
                document.body.removeChild(modalOverlay);
            };
            
            document.getElementById('modal-cancel').onclick = () => {
                document.body.removeChild(modalOverlay);
            };
        }

        /**
         * Displays a custom modal prompt.
         * @param {string} message - The prompt message.
         * @param {function(string)} onSubmit - Callback function with the input text.
         */
        function showPrompt(message, onSubmit) {
            const promptOverlay = document.createElement('div');
            promptOverlay.id = 'prompt-overlay';
            promptOverlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[90] flex items-center justify-center';
            
            promptOverlay.innerHTML = `
                <form id="prompt-form" class="bg-white dark:bg-charcoal p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <label class="block text-lg text-charcoal dark:text-warm-cream mb-4" for="prompt-input">${message}</label>
                    <textarea id="prompt-input" rows="3" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-charcoal dark:text-warm-cream border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-deep-purple focus:outline-none"></textarea>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="prompt-cancel" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancel</button>
                        <button type="submit" id="prompt-submit" class="px-4 py-2 rounded-lg bg-deep-purple text-white hover:bg-deep-purple/80 transition-colors">Save</button>
                    </div>
                </form>
            `;
            
            document.body.appendChild(promptOverlay);
            const input = document.getElementById('prompt-input');
            input.focus();

            document.getElementById('prompt-form').onsubmit = (e) => {
                e.preventDefault();
                onSubmit(input.value);
                document.body.removeChild(promptOverlay);
            };
            
            document.getElementById('prompt-cancel').onclick = () => {
                document.body.removeChild(promptOverlay);
            };
        }


        // --- Theme Toggle Script ---
        const themeToggleButton = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        
        const setTheme = (isDark) => {
            if (isDark) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                if (lightIcon && darkIcon) {
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                if (lightIcon && darkIcon) {
                    darkIcon.classList.remove('hidden');
                    lightIcon.classList.add('hidden');
                }
            }
        };

        // Set initial theme state on load
        const isCurrentlyDark = document.documentElement.classList.contains('dark');
        setTheme(isCurrentlyDark);

        // Add click listener
        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', () => {
                setTheme(!document.documentElement.classList.contains('dark'));
            });
        }
    </script>

</body>
</html>

