<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-R">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoomEd App - Dream Forge Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'deep-purple': '#6B4FBF',
                        'warm-cream': '#FFF8E7',
                        'coral-pink': '#FF7B68',
                        'ocean-teal': '#2DBFB8',
                        'golden-yellow': '#FFB84D',
                        'forest-green': '#4A7C59',
                        'slate-gray': '#6B7280',
                        'soft-red': '#E86C6C',
                        'charcoal': '#2D3748',
                        'medium-purple': '#8B7AB8',
                    },
                    fontFamily: {
                        display: ['Fredoka', 'sans-serif'],
                        body: ['Lexend', 'sans-serif'],
                        ui: ['Inter', 'sans-serif'],
                    }
                }
            },
            // Add the typography plugin
            plugins: [
                require('@tailwindcss/typography'),
            ],
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600&family=Inter:wght@400;500&family=Lexend:wght@400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFF8E7; /* Warm Cream */
        }
        .dark body {
            background: #1a202c; /* Dark Charcoal */
        }
        ::selection {
            background-color: #6B4FBF; /* Deep Purple */
            color: #ffffff;
        }
        .dark ::selection {
            background-color: #FFB84D; /* Golden Yellow */
            color: #1a202c;
        }
        
        /* Highlight Styling */
        .highlight {
            background-color: rgba(255, 184, 77, 0.7); /* Golden Yellow with transparency */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .highlight:hover {
            background-color: rgba(255, 184, 77, 1);
        }
        .dark .highlight {
            background-color: rgba(107, 79, 191, 0.7); /* Deep Purple with transparency */
        }
        .dark .highlight:hover {
            background-color: rgba(107, 79, 191, 1);
        }
        
        /* Note Styling */
        .note-highlight {
            background-color: rgba(45, 191, 184, 0.7); /* Ocean Teal with transparency */
            cursor: pointer;
            border-bottom: 2px dotted #0f5e5b;
            transition: background-color 0.2s;
        }
        .note-highlight:hover {
             background-color: rgba(45, 191, 184, 1);
        }
        .dark .note-highlight {
            background-color: rgba(255, 123, 104, 0.6); /* Coral Pink with transparency */
            border-bottom: 2px dotted #FF7B68;
        }
        .dark .note-highlight:hover {
             background-color: rgba(255, 123, 104, 1);
        }

        /* Skeleton Loader */
        .skeleton {
            background-color: #e0dccc;
            border-radius: 0.25rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .dark .skeleton {
            background-color: #374151; /* gray-700 */
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
    </style>
     <script>
        // Set theme on initial load to prevent FOUC and default to light mode
        if (localStorage.getItem('theme') === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="antialiased font-ui text-charcoal dark:text-warm-cream">

    <!-- Header -->
    <header class="bg-warm-cream/80 dark:bg-charcoal/80 backdrop-blur-md sticky top-0 z-50 border-b border-medium-purple dark:border-deep-purple">
        <div class="container mx-auto px-6 py-4">
            <nav class="flex items-center justify-between">
                <a href="../index.html" class="text-2xl font-display font-semibold text-deep-purple dark:text-warm-cream flex items-center">
                    <i class="fas fa-book-reader mr-2 text-deep-purple dark:text-warm-cream"></i> LoomEd
                </a>
                <div class="flex items-center space-x-4">
                    <a href="../index.html#loom-ed" class="hidden md:block text-medium-purple dark:text-warm-cream hover:text-deep-purple dark:hover:text-deep-purple transition-colors">Back to Home</a>
                    <button id="theme-toggle" class="text-medium-purple dark:text-warm-cream hover:text-deep-purple dark:hover:text-deep-purple transition-colors w-10 h-10 flex items-center justify-center rounded-lg hover:bg-warm-cream/50 dark:hover:bg-charcoal/50">
                        <i class="fas fa-moon text-xl hidden" id="theme-toggle-dark-icon"></i>
                        <i class="fas fa-sun text-xl hidden" id="theme-toggle-light-icon"></i>
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main App Content -->
    <main class="container mx-auto px-6 py-8">
        <div class="flex flex-col md:flex-row gap-8">
            
            <!-- Sidebar with Story List & Notes -->
            <aside class="w-full md:w-1/3 lg:w-1/4 space-y-8">
                <!-- Story List -->
                <div class="bg-white dark:bg-charcoal/50 p-6 rounded-xl shadow-lg border border-medium-purple dark:border-deep-purple">
                    <h2 class="text-2xl font-display font-bold text-deep-purple dark:text-warm-cream mb-4">Available Stories</h2>
                    <div id="story-list" class="space-y-2">
                        <!-- Skeleton Loader -->
                        <div class="space-y-3">
                            <div class="h-5 w-3/4 skeleton"></div>
                            <div class="h-5 w-full skeleton"></div>
                            <div class="h-5 w-5/6 skeleton"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Notes & Highlights List -->
                <div id="notes-panel" class="bg-white dark:bg-charcoal/50 p-6 rounded-xl shadow-lg border border-medium-purple dark:border-deep-purple hidden">
                    <h2 class="text-2xl font-display font-bold text-deep-purple dark:text-warm-cream mb-4">My Notes & Highlights</h2>
                    <div id="notes-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        <!-- Notes will be injected here -->
                        <p id="notes-placeholder" class="text-slate-gray dark:text-gray-400">Select a story to see your notes.</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area for Reading -->
            <div class="w-full md:w-2/3 lg:w-3/4">
                <div id="story-content-area" class="bg-white dark:bg-charcoal/50 p-6 sm:p-8 md:p-12 rounded-xl shadow-lg border border-medium-purple dark:border-deep-purple min-h-[70vh]">
                    
                    <!-- NEW: Story Actions -->
                    <div id="story-actions" class="flex justify-end mb-4 -mt-4 -mr-2 sm:-mr-4 md:-mr-8 hidden">
                        <button id="ai-summary-btn" class="bg-deep-purple hover:bg-deep-purple/80 text-white dark:bg-golden-yellow dark:text-charcoal dark:hover:bg-golden-yellow/80 px-4 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center shadow-md hover:shadow-lg">
                            <i class="fas fa-wand-magic-sparkles mr-2"></i>
                            AI Summary
                        </button>
                    </div>

                    <div id="story-placeholder" class="flex flex-col items-center justify-center h-full min-h-[50vh] text-center">
                         <i class="fas fa-book-open text-6xl text-medium-purple dark:text-gray-500 mb-6"></i>
                        <h2 class="text-3xl font-display font-bold text-deep-purple dark:text-warm-cream mb-2">Welcome to LoomEd!</h2>
                        <p class="text-lg text-slate-gray dark:text-gray-400">Please select a story from the list to begin reading.</p>
                    </div>
                    <!-- Added prose class for typography styling -->
                    <div id="story-text" class="hidden prose dark:prose-invert max-w-none prose-lg prose-p:leading-relaxed prose-p:my-4">
                        <!-- Story content will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Pop-up for Highlighting and Notes -->
    <div id="tooltip" class="hidden absolute bg-charcoal dark:bg-warm-cream text-white dark:text-charcoal p-2 rounded-lg shadow-xl z-50 space-x-1">
        <button id="highlight-btn" class="px-3 py-1 hover:bg-deep-purple dark:hover:bg-golden-yellow rounded transition-colors"><i class="fas fa-highlighter mr-1"></i> Highlight</button>
        <button id="note-btn" class="px-3 py-1 hover:bg-deep-purple dark:hover:bg-golden-yellow rounded transition-colors"><i class="fas fa-pencil-alt mr-1"></i> Take Note</button>
    </div>


    <script>
        // --- Configuration ---
        const API_BASE_URL = 'https://dgv9q2uuuf.execute-api.us-east-2.amazonaws.com/Prod';
        const STORIES_API_URL = `${API_BASE_URL}/stories`;
        const STORY_CONTENT_API_URL = `${API_BASE_URL}/story`; // Updated to /story from /stories
        const ANNOTATIONS_API_URL = `${API_BASE_URL}/annotations`;
        // NEW: Add the Summary API URL
        const SUMMARY_API_URL = `${API_BASE_URL}/summary`;


        // --- DOM Elements ---
        const storyListContainer = document.getElementById('story-list');
        const storyContentArea = document.getElementById('story-content-area');
        const storyPlaceholder = document.getElementById('story-placeholder');
        const storyTextContainer = document.getElementById('story-text');
        const notesPanel = document.getElementById('notes-panel');
        const notesList = document.getElementById('notes-list');
        const notesPlaceholder = document.getElementById('notes-placeholder');
        
        const tooltip = document.getElementById('tooltip');
        const highlightBtn = document.getElementById('highlight-btn');
        const noteBtn = document.getElementById('note-btn');
        
        // --- App State ---
        let selectedRange = null;
        let currentStoryId = null;
        let activeStoryButton = null; 
        
        // --- User ID Management (New) ---
        
        /**
         * Gets a unique user ID from localStorage, creating one if it doesn't exist.
         * @returns {string} The user's unique ID.
         */
        function getUserId() {
            let userId = localStorage.getItem('loomEdUserId');
            if (!userId) {
                userId = `user_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                localStorage.setItem('loomEdUserId', userId);
            }
            return userId;
        }

        // --- API & Data Functions ---

        /**
         * Shows a skeleton loading animation in the story list.
         */
         function showLoadingState() {
            storyListContainer.innerHTML = `
                <div class="space-y-3">
                    <div class="h-5 w-3/4 skeleton"></div>
                    <div class="h-5 w-full skeleton"></div>
                    <div class="h-5 w-5/6 skeleton"></div>
                </div>
            `;
        }
        
        /**
         * Shows a robust error message with a retry button.
         * @param {string} errorMessage - The error message to display (e.g., from a network error).
         */
        function showErrorState(errorMessage) {
            storyListContainer.innerHTML = `
                <div class="text-center p-4 bg-soft-red/10 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-soft-red text-3xl mb-3"></i>
                    <p class="font-semibold text-soft-red mb-2">Failed to load stories.</p>
                    <p class="text-xs text-slate-gray dark:text-gray-400 mb-4">
                        Error: ${errorMessage}
                    </p>
                    <button id="retry-button" class="bg-deep-purple hover:bg-deep-purple/80 text-white dark:bg-golden-yellow dark:text-charcoal dark:hover:bg-golden-yellow/80 px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                        Retry
                    </button>
                </div>
            `;
            // Note: The click listener for this is now handled by delegation
        }


        /**
         * Fetches the list of stories from the API and displays them.
         */
        async function fetchStories() {
            showLoadingState(); 
            
            try {
                const response = await fetch(STORIES_API_URL);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    showErrorState(errorData.error || `Network response was not ok (status: ${response.status})`);
                    return; // Stop execution if error
                }
                const stories = await response.json();
                displayStoryList(stories);
            } catch (error) {
                console.error('Error fetching stories:', error);
                showErrorState(error.message);
            }
        }

        /**
         * Renders the list of stories in the sidebar.
         * @param {Array} stories - An array of story objects {id, title}.
         */
        function displayStoryList(stories) {
            storyListContainer.innerHTML = '';
            if (stories.length === 0) {
                storyListContainer.innerHTML = `<p class="text-slate-gray dark:text-gray-400">No stories found.</p>`;
                return;
            }
            
            stories.forEach(story => {
                const button = document.createElement('button');
                button.className = 'block w-full text-left px-4 py-2 rounded-lg text-deep-purple dark:text-gray-300 hover:bg-warm-cream dark:hover:bg-charcoal/70 transition-colors';
                button.textContent = story.title;
                button.dataset.storyId = story.id;
                button.onclick = () => {
                    if (activeStoryButton) {
                        activeStoryButton.classList.remove('bg-warm-cream', 'dark:bg-charcoal/70', 'font-semibold');
                    }
                    button.classList.add('bg-warm-cream', 'dark:bg-charcoal/70', 'font-semibold');
                    activeStoryButton = button;
                    
                    fetchStoryContent(story.id);
                };
                storyListContainer.appendChild(button);
            });
        }

        /**
         * Fetches and displays the content for a specific story.
         * @param {string} storyId - The ID (S3 key) of the story.
         */
        async function fetchStoryContent(storyId) {
            // Don't reload the same story
            if (currentStoryId === storyId) return; 
            currentStoryId = storyId;
            
            // NEW: Hide actions on load
            document.getElementById('story-actions').classList.add('hidden');
            
            storyPlaceholder.classList.remove('hidden');
            storyPlaceholder.innerHTML = `
                <i class="fas fa-spinner fa-spin text-6xl text-medium-purple dark:text-gray-500 mb-6"></i>
                <p class="text-lg text-slate-gray dark:text-gray-400">Loading story...</p>`;
            storyTextContainer.classList.add('hidden');
            storyTextContainer.innerHTML = '';
            notesPanel.classList.remove('hidden'); // Show the notes panel

            try {
                // Fetch story content
                const response = await fetch(`${STORY_CONTENT_API_URL}?id=${encodeURIComponent(storyId)}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Network response was not ok (status: ${response.status})`);
                }
                const story = await response.json();
                
                // Display story content
                const title = story.title ?? storyId.replace('.pdf', '').replace(/_/g, ' '); // Get title
                const paragraphs = story.content.split('\n').filter(p => p.trim() !== '').map(p => `<p class="select-text">${p}</p>`).join('');
                storyTextContainer.innerHTML = `<h1>${title}</h1>${paragraphs}`;
                storyPlaceholder.classList.add('hidden');
                storyTextContainer.classList.remove('hidden');
                
                // NEW: Show actions
                document.getElementById('story-actions').classList.remove('hidden');
                
                // After content is loaded, load annotations
                await loadAnnotationsForStory(storyId);

            } catch (error) {
                console.error('Error fetching story content:', error);
                
                // NEW: Ensure actions are hidden on error
                document.getElementById('story-actions').classList.add('hidden');

                storyPlaceholder.classList.remove('hidden');
                storyPlaceholder.innerHTML = `
                    <i class="fas fa-exclamation-circle text-6xl text-soft-red dark:text-coral-pink mb-6"></i>
                    <h2 class="text-3xl font-display font-bold text-soft-red dark:text-coral-pink mb-2">Error Loading Story</h2>
                    <p class="text-lg text-slate-gray dark:text-gray-400">${error.message}</p>`;
            }
        }

        // --- Functions for AWS Integration ---

        /**
         * Loads all annotations for the current story from the API.
         * @param {string} storyId - The ID of the story.
         */
        async function loadAnnotationsForStory(storyId) {
            notesList.innerHTML = `<p id="notes-placeholder" class="text-slate-gray dark:text-gray-400">Loading notes...</p>`;
            
            try {
                const userId = getUserId();
                const response = await fetch(`${ANNOTATIONS_API_URL}?userId=${userId}&storyId=${encodeURIComponent(storyId)}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Network response was not ok (status: ${response.status})`);
                }
                
                const annotations = await response.json();
                annotations.sort((a, b) => a.createdAt - b.createdAt);
                
                renderAnnotations(annotations);
                setTimeout(() => applyAnnotationsToText(annotations), 10);
                
            } catch (error) {
                 console.error('Error loading annotations:', error);
                 notesList.innerHTML = `
                    <p class="text-soft-red dark:text-coral-pink text-sm">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <strong>Could not load notes.</strong>
                        <span class="block text-xs text-slate-gray dark:text-gray-400 mt-1">${error.message}</span>
                    </p>`;
            }
        }

        /**
         * Renders the list of notes and highlights in the sidebar.
         * @param {Array} annotations - An array of annotation objects.
         */
        function renderAnnotations(annotations) {
            notesList.innerHTML = '';
            if (annotations.length === 0) {
                notesList.innerHTML = `<p id="notes-placeholder" class="text-slate-gray dark:text-gray-400">You have no notes or highlights for this story.</p>`;
                return;
            }
            
            annotations.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-3 rounded-lg bg-warm-cream/50 dark:bg-charcoal/70 border border-medium-purple/30 dark:border-deep-purple/50';
                
                let icon = '';
                if (item.type === 'note') {
                    icon = '<i class="fas fa-pencil-alt text-ocean-teal dark:text-coral-pink mr-2"></i>';
                    div.innerHTML = `
                        <p class="text-sm font-semibold">${icon} Note</p>
                        <p class="text-xs text-slate-gray dark:text-gray-400 italic my-1">"${item.text}"</p>
                        <p class="text-sm mt-1">${item.note}</p>
                    `;
                } else {
                    icon = '<i class="fas fa-highlighter text-golden-yellow dark:text-deep-purple mr-2"></i>';
                     div.innerHTML = `
                        <p class="text-sm font-semibold">${icon} Highlight</p>
                        <p class="text-xs text-slate-gray dark:text-gray-400 italic my-1">"${item.text}"</p>
                    `;
                }
                notesList.appendChild(div);
            });
        }
        
        /**
         * Saves a new annotation (highlight or note) to the API.
         * @param {object} annotation - The annotation object to save.
         */
        async function saveAnnotation(annotation) {
            try {
                const response = await fetch(ANNOTATIONS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(annotation)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Failed to save (status: ${response.status})`);
                }
                
                // After successful save, reload the annotations
                await loadAnnotationsForStory(annotation.storyId);
                
            } catch (error) {
                console.error('Error saving annotation:', error);
                showToast(`Error: Could not save annotation.`);
            }
        }

        /**
         * Applies saved annotations to the story text.
         * @param {Array} annotations - An array of annotation objects.
         */
        function applyAnnotationsToText(annotations) {
            const paragraphs = storyTextContainer.querySelectorAll('p');
            paragraphs.forEach(p => {
                let html = p.innerHTML;
                
                annotations.filter(a => a.type === 'note').forEach(item => {
                    html = html.replace(new RegExp(escapeRegExp(item.text), 'g'), 
                        `<span class="note-highlight" title="Note: ${item.note.replace(/"/g, '&quot;')}">${item.text}</span>`);
                });
                
                annotations.filter(a => a.type === 'highlight').forEach(item => {
                    html = html.replace(new RegExp(escapeRegExp(item.text), 'g'), 
                        (match) => {
                            if (match.includes('class="note-highlight"')) return match;
                            return `<span class="highlight">${item.text}</span>`;
                        }
                    );
                });
                
                p.innerHTML = html;
            });

            addAnnotationClickListeners();
        }
        
        /**
         * Adds click handlers to all annotation spans (Uses your showModal).
         */
        function addAnnotationClickListeners() {
            storyTextContainer.querySelectorAll('.highlight, .note-highlight').forEach(span => {
                span.onclick = (e) => { 
                    e.stopPropagation(); 
                    const type = span.classList.contains('note-highlight') ? 'note' : 'highlight';
                    const text = span.textContent;
                    
                    showModal(
                        `Remove this ${type}?`, 
                        () => {
                            // This is the onConfirm callback
                            const parent = span.parentNode;
                            while(span.firstChild) parent.insertBefore(span.firstChild, span);
                            parent.removeChild(span);
                            parent.normalize(); // Clean up text nodes
                            
                            // TODO: Add DB deletion logic here
                            showToast('Annotation removed from page.');
                        }
                    );
                };
            });
        }
        
        /**
         * Escapes text for use in a regular expression.
         * @param {string} string - The text to escape.
         */
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
        }

        // --- Event Listeners ---
        
        // 1. Initial page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchStories();
            
            // NEW: AI Summary Button Listener
            document.getElementById('ai-summary-btn').addEventListener('click', () => {
                if (currentStoryId) {
                    fetchAiSummary(currentStoryId);
                } else {
                    showToast('Please select a story first.');
                }
            });
        });
        
        // 2. Retry Button (using event delegation)
        storyListContainer.addEventListener('click', (event) => {
            if (event.target && event.target.id === 'retry-button') {
                fetchStories(); // Re-run the fetch function
            }
        });

        // 3. Text Selection (Mouse Up)
        storyTextContainer.addEventListener('mouseup', (event) => {
            // Don't show tooltip if a modal is open
            if (document.getElementById('modal-overlay') || document.getElementById('prompt-overlay') || document.getElementById('loading-modal-overlay') || document.getElementById('info-modal-overlay')) {
                return;
            }

            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 0) {
                selectedRange = selection.getRangeAt(0);
                const rect = selectedRange.getBoundingClientRect();
                
                tooltip.style.left = `${window.scrollX + rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
                tooltip.style.top = `${window.scrollY + rect.top - tooltip.offsetHeight - 10}px`;
                tooltip.classList.remove('hidden');
            } else {
                tooltip.classList.add('hidden');
            }
        });
        
        // 4. Hide tooltip on outside click
        document.addEventListener('mousedown', (event) => {
             if (!tooltip.contains(event.target) && !storyTextContainer.contains(event.target)) {
                tooltip.classList.add('hidden');
                window.getSelection().removeAllRanges();
                selectedRange = null;
             }
        });

        // 5. Highlight button click handler (Updated to save)
        highlightBtn.addEventListener('click', async () => {
            if (selectedRange) {
                const text = selectedRange.toString().trim();
                const annotation = {
                    userId: getUserId(),
                    storyId: currentStoryId,
                    type: 'highlight',
                    text: text,
                    note: '',
                    range: {} // Placeholder
                };
                
                // Save to AWS
                await saveAnnotation(annotation);
                
                window.getSelection().removeAllRanges();
                tooltip.classList.add('hidden');
                selectedRange = null;
            }
        });

        // 6. Note button click handler (Updated to save)
        noteBtn.addEventListener('click', () => {
            if (selectedRange) {
                const text = selectedRange.toString().trim();
                
                showPrompt('Enter your note:', async (noteText) => {
                    if (noteText) { 
                        const annotation = {
                            userId: getUserId(),
                            storyId: currentStoryId,
                            type: 'note',
                            text: text,
                            note: noteText,
                            range: {} // Placeholder
                        };
                        
                        // Save to AWS
                        await saveAnnotation(annotation);
                        showToast('Note saved!');
                    }
                    
                    window.getSelection().removeAllRanges();
                    tooltip.classList.add('hidden');
                    selectedRange = null;
                });
            }
        });

        // --- UI Helper Functions ---

        /**
         * Displays a simple toast message at the top of the screen.
         * @param {string} message - The message to display.
         */
        function showToast(message) {
            const toast = document.createElement('div');
            // Added z-index to be sure it's on top
            toast.className = 'fixed top-5 right-5 bg-charcoal text-white px-5 py-3 rounded-lg shadow-xl z-[1001] transition-all duration-300 translate-x-full opacity-0';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 10);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        /**
         * Displays a custom modal confirmation dialog.
         * @param {string} message - The question to ask.
         * @param {function} onConfirm - Callback function to run if "OK" is clicked.
         */
        function showModal(message, onConfirm) {
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'modal-overlay';
            // Increased z-index
            modalOverlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[1000] flex items-center justify-center p-4';
            
            modalOverlay.innerHTML = `
                <div class="bg-white dark:bg-charcoal p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <p class="text-lg text-charcoal dark:text-warm-cream mb-6">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="modal-cancel" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancel</button>
                        <button id="modal-ok" class="px-4 py-2 rounded-lg bg-deep-purple text-white hover:bg-deep-purple/80 transition-colors">OK</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);

            document.getElementById('modal-ok').onclick = () => {
                onConfirm();
                if (document.body.contains(modalOverlay)) {
                    document.body.removeChild(modalOverlay);
                }
            };
            
            document.getElementById('modal-cancel').onclick = () => {
                if (document.body.contains(modalOverlay)) {
                    document.body.removeChild(modalOverlay);
                }
            };
        }

        /**
         * Displays a custom modal prompt.
         * @param {string} message - The prompt message.
         * @param {function(string)} onSubmit - Callback function with the input text.
         */
        function showPrompt(message, onSubmit) {
            const promptOverlay = document.createElement('div');
            promptOverlay.id = 'prompt-overlay';
            // Increased z-index
            promptOverlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[1000] flex items-center justify-center p-4';
            
            promptOverlay.innerHTML = `
                <form id="prompt-form" class="bg-white dark:bg-charcoal p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <label class="block text-lg text-charcoal dark:text-warm-cream mb-4" for="prompt-input">${message}</label>
                    <textarea id="prompt-input" rows="3" class="w-full px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-charcoal dark:text-warm-cream border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-deep-purple focus:outline-none"></textarea>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="prompt-cancel" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancel</button>
                        <button type="submit" id="prompt-submit" class="px-4 py-2 rounded-lg bg-deep-purple text-white hover:bg-deep-purple/80 transition-colors">Save</button>
                    </div>
                </form>
            `;
            
            document.body.appendChild(promptOverlay);
            const input = document.getElementById('prompt-input');
            input.focus();

            document.getElementById('prompt-form').onsubmit = (e) => {
                e.preventDefault();
                onSubmit(input.value);
                if (document.body.contains(promptOverlay)) {
                    document.body.removeChild(promptOverlay);
                }
            };
            
            document.getElementById('prompt-cancel').onclick = () => {
                if (document.body.contains(promptOverlay)) {
                    document.body.removeChild(promptOverlay);
                }
            };
        }

        // --- NEW: AI Summary Functions ---

        /**
         * Fetches an AI-generated summary for the current story.
         * @param {string} storyId - The ID (S3 key) of the story.
         */
        async function fetchAiSummary(storyId) {
            // 1. Show loading modal
            showLoadingModal('Generating AI Summary...');

            try {
                const response = await fetch(`${SUMMARY_API_URL}?storyId=${encodeURIComponent(storyId)}`);
                
                const data = await response.json();

                // Close loading modal
                closeLoadingModal();

                if (!response.ok) {
                    // Use data.error from Lambda, or a default
                    throw new Error(data.error || `Network response was not ok (status: ${response.status})`);
                }

                if (!data.summary) {
                    throw new Error("Summary was not found in the response.");
                }

                // 2. Display the summary, replacing the original text
                const formattedSummary = data.summary.split('\n')
                    .filter(p => p.trim() !== '')
                    .map(p => `<p class="mb-3">${p}</p>`) // Added spacing
                    .join('');
                
                storyTextContainer.innerHTML = `
                    <h1 class="text-deep-purple dark:text-warm-cream mb-4">AI-Generated Summary</h1>
                    ${formattedSummary}
                `;
                
                // Hide the tooltip and clear selection, as it's no longer relevant
                tooltip.classList.add('hidden');
                window.getSelection().removeAllRanges();
                selectedRange = null;

            } catch (error) {
                console.error('Error fetching AI summary:', error);
                closeLoadingModal();
                // Error is still shown in a modal
                showInfoModal('Error', `Could not generate summary: ${error.message}`);
            }
        }

        /**
         * Displays a persistent loading modal.
         * @param {string} message - The loading message.
         */
        function showLoadingModal(message) {
            // Close any existing modal
            closeLoadingModal();

            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'loading-modal-overlay';
            // Increased z-index
            modalOverlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[1000] flex items-center justify-center p-4';
            
            modalOverlay.innerHTML = `
                <div class="bg-white dark:bg-charcoal p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-deep-purple dark:text-golden-yellow mb-4"></i>
                    <p class="text-lg text-charcoal dark:text-warm-cream">${message}</p>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
        }

        /**
         * Closes the loading modal.
         */
        function closeLoadingModal() {
            const modalOverlay = document.getElementById('loading-modal-overlay');
            if (modalOverlay && document.body.contains(modalOverlay)) {
                document.body.removeChild(modalOverlay);
            }
        }

        /**
         * Displays a custom modal with info and an "OK" button.
         * @param {string} title - The modal title.
         * @param {string} message - The info message (will be formatted).
         */
        function showInfoModal(title, message) {
            // Close any other modals first
            closeLoadingModal();
            const existingInfoModal = document.getElementById('info-modal-overlay');
            if (existingInfoModal) document.body.removeChild(existingInfoModal);

            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'info-modal-overlay';
            // Increased z-index
            modalOverlay.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-[1000] flex items-center justify-center p-4';
            
            // Format the message with paragraphs for newlines
            const formattedMessage = message.split('\n').filter(p => p.trim() !== '').map(p => `<p class="mb-3">${p}</p>`).join('');

            modalOverlay.innerHTML = `
                <div class="bg-white dark:bg-charcoal p-6 rounded-lg shadow-xl w-full max-w-md" id="info-modal-content">
                    <h3 class="text-xl font-display font-bold text-deep-purple dark:text-warm-cream mb-4">${title}</h3>
                    <div classa="text-charcoal dark:text-warm-cream max-h-[60vh] overflow-y-auto pr-2">
                        ${formattedMessage}
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="info-modal-ok" class="px-4 py-2 rounded-lg bg-deep-purple text-white hover:bg-deep-purple/80 transition-colors">OK</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);

            const closeBtn = document.getElementById('info-modal-ok');
            const overlay = document.getElementById('info-modal-overlay');

            closeBtn.onclick = () => {
                if (overlay && document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }
            };

            // Also close if clicking overlay
            overlay.onclick = (e) => {
                 // Check if click is on the overlay itself, not the content
                 if (e.target.id === 'info-modal-overlay') {
                     closeBtn.click();
                 }
            };
        }

        // --- Theme Toggle Script ---
        const themeToggleButton = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        
        const setTheme = (isDark) => {
            if (isDark) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                if (lightIcon && darkIcon) {
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                if (lightIcon && darkIcon) {
                    darkIcon.classList.remove('hidden');
                    lightIcon.classList.add('hidden');
                }
            }
        };

        const isCurrentlyDark = document.documentElement.classList.contains('dark');
        setTheme(isCurrentlyDark);

        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', () => {
                setTheme(!document.documentElement.classList.contains('dark'));
            });
        }
    </script>
</body>
</html>

