<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoomEd App - Dream Forge Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'deep-purple': '#6B4FBF',
                        'warm-cream': '#FFF8E7',
                        'coral-pink': '#FF7B68',
                        'ocean-teal': '#2DBFB8',
                        'golden-yellow': '#FFB84D',
                        'forest-green': '#4A7C59',
                        'slate-gray': '#6B7280',
                        'soft-red': '#E86C6C',
                        'charcoal': '#2D3748',
                        'medium-purple': '#8B7AB8',
                    },
                    fontFamily: {
                        display: ['Fredoka', 'sans-serif'],
                        body: ['Lexend', 'sans-serif'],
                        ui: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600&family=Inter:wght@400;500&family=Lexend:wght@400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFF8E7; /* Warm Cream */
        }
        .dark body {
            background: #1a202c; /* Dark Charcoal */
        }
        ::selection {
            background-color: #6B4FBF; /* Deep Purple */
            color: #ffffff;
        }
        .dark ::selection {
            background-color: #FFB84D; /* Golden Yellow */
            color: #1a202c;
        }
        .highlight {
            background-color: #FFB84D;
            cursor: pointer;
        }
        .dark .highlight {
            background-color: #6B4FBF;
        }
    </style>
    <script>
        // Set theme on initial load to prevent FOUC and default to light mode
        if (localStorage.getItem('theme') === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="antialiased font-ui text-charcoal dark:text-warm-cream">

    <!-- Header -->
    <header class="bg-warm-cream/80 dark:bg-charcoal/80 backdrop-blur-md sticky top-0 z-50 border-b border-medium-purple dark:border-deep-purple">
        <div class="container mx-auto px-6 py-4">
            <nav class="flex items-center justify-between">
                <a href="../index.html" class="text-2xl font-display font-semibold text-deep-purple dark:text-warm-cream flex items-center">
                    <i class="fas fa-book-reader mr-2 text-deep-purple dark:text-warm-cream"></i> LoomEd
                </a>
                <div class="flex items-center space-x-4">
                    <a href="../index.html#loom-ed" class="hidden md:block text-medium-purple dark:text-warm-cream hover:text-deep-purple dark:hover:text-deep-purple transition-colors">Back to Home</a>
                    <button id="theme-toggle" class="text-medium-purple dark:text-warm-cream hover:text-deep-purple dark:hover:text-deep-purple transition-colors w-10 h-10 flex items-center justify-center rounded-lg hover:bg-warm-cream dark:hover:bg-charcoal">
                        <i class="fas fa-moon text-xl hidden" id="theme-toggle-dark-icon"></i>
                        <i class="fas fa-sun text-xl hidden" id="theme-toggle-light-icon"></i>
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main App Content -->
    <main class="container mx-auto px-6 py-8">
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Sidebar with Story List -->
            <aside class="w-full md:w-1/4">
                <div class="bg-white dark:bg-charcoal/50 p-6 rounded-xl shadow-lg border border-medium-purple dark:border-deep-purple">
                    <h2 class="text-2xl font-display font-bold text-deep-purple dark:text-warm-cream mb-4">Short Stories</h2>
                    <div id="story-list" class="space-y-2">
                        <!-- Story links will be injected here -->
                        <p class="text-slate-gray dark:text-gray-400">Loading stories...</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area for Reading -->
            <div class="w-full md:w-3/4">
                <div id="story-content-area" class="bg-white dark:bg-charcoal/50 p-8 rounded-xl shadow-lg border border-medium-purple dark:border-deep-purple prose dark:prose-invert max-w-none prose-lg prose-p:leading-relaxed">
                    <p id="story-placeholder">Please select a story from the list to begin reading.</p>
                    <div id="story-text" class="hidden"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Pop-up for Highlighting and Notes -->
    <div id="tooltip" class="hidden absolute bg-charcoal dark:bg-warm-cream text-white dark:text-charcoal p-2 rounded-lg shadow-xl z-50">
        <button id="highlight-btn" class="px-3 py-1 hover:bg-deep-purple dark:hover:bg-golden-yellow rounded">Highlight</button>
        <button id="note-btn" class="px-3 py-1 hover:bg-deep-purple dark:hover:bg-golden-yellow rounded">Take Note</button>
    </div>

    <script>
        // --- Configuration ---
        const API_BASE_URL = 'https://d2drk2p096.execute-api.us-east-2.amazonaws.com/prod';

        // --- DOM Elements ---
        const storyListContainer = document.getElementById('story-list');
        const storyContentArea = document.getElementById('story-content-area');
        const storyPlaceholder = document.getElementById('story-placeholder');
        const storyTextContainer = document.getElementById('story-text');
        const tooltip = document.getElementById('tooltip');
        const highlightBtn = document.getElementById('highlight-btn');
        const noteBtn = document.getElementById('note-btn');

        let selectedRange = null;

        // --- Story Loading and Display ---
        async function fetchStories() {
            try {
                const response = await fetch(`${API_BASE_URL}/stories`);
                if (!response.ok) throw new Error('Failed to fetch stories.');
                const stories = await response.json();
                displayStoryList(stories);
            } catch (error) {
                console.error('Error fetching stories:', error);
                storyListContainer.innerHTML = `<p class="text-soft-red">Could not load stories.</p>`;
            }
        }

        function displayStoryList(stories) {
            storyListContainer.innerHTML = '';
            stories.forEach(story => {
                const button = document.createElement('button');
                button.className = 'block w-full text-left px-4 py-2 rounded-lg text-medium-purple dark:text-gray-300 hover:bg-warm-cream dark:hover:bg-charcoal transition-colors';
                button.textContent = story.title;
                button.onclick = () => fetchStoryContent(story.id);
                storyListContainer.appendChild(button);
            });
        }

        async function fetchStoryContent(storyId) {
            try {
                storyPlaceholder.textContent = 'Loading story...';
                storyTextContainer.classList.add('hidden');
                const response = await fetch(`${API_BASE_URL}/stories/${storyId}`);
                if (!response.ok) throw new Error('Failed to fetch story content.');
                const story = await response.json();
                displayStoryContent(story.content);
            } catch (error) {
                console.error('Error fetching story content:', error);
                storyPlaceholder.textContent = 'Could not load the selected story.';
            }
        }

        function displayStoryContent(content) {
            storyPlaceholder.classList.add('hidden');
            storyTextContainer.classList.remove('hidden');
            storyTextContainer.innerHTML = content.split('\n').map(p => `<p>${p}</p>`).join('');
        }
        
        // --- Highlighting and Note-taking ---
        storyTextContainer.addEventListener('mouseup', (event) => {
            const selection = window.getSelection();
            if (selection.toString().trim().length > 0) {
                selectedRange = selection.getRangeAt(0);
                const rect = selectedRange.getBoundingClientRect();
                tooltip.style.left = `${window.scrollX + rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
                tooltip.style.top = `${window.scrollY + rect.top - tooltip.offsetHeight - 10}px`;
                tooltip.classList.remove('hidden');
            } else {
                tooltip.classList.add('hidden');
            }
        });
        
        document.addEventListener('mousedown', (event) => {
             if (!tooltip.contains(event.target) && !storyTextContainer.contains(event.target)) {
                tooltip.classList.add('hidden');
            }
        });


        highlightBtn.addEventListener('click', () => {
            if (selectedRange) {
                const span = document.createElement('span');
                span.className = 'highlight';
                span.onclick = (e) => {
                     if(confirm('Remove highlight?')) {
                        const parent = e.target.parentNode;
                        while(e.target.firstChild) parent.insertBefore(e.target.firstChild, e.target);
                        parent.removeChild(e.target);
                     }
                };
                try {
                    span.appendChild(selectedRange.extractContents());
                    selectedRange.insertNode(span);
                } catch(e) {
                     console.error("Could not highlight this selection.", e);
                }
                window.getSelection().removeAllRanges();
                tooltip.classList.add('hidden');
                selectedRange = null;
            }
        });

        noteBtn.addEventListener('click', () => {
            if (selectedRange) {
                const noteText = prompt("Enter your note:", "");
                if (noteText) {
                    // In a real app, you would save this to a database.
                    // For now, we'll just log it.
                    const highlightedText = selectedRange.toString();
                    console.log(`Note added for text: "${highlightedText}"\nNote: "${noteText}"`);
                    alert('Note saved! (Check the console)');
                }
                window.getSelection().removeAllRanges();
                tooltip.classList.add('hidden');
                selectedRange = null;
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchStories();
        });

        // --- Theme Toggle Script ---
        const themeToggleButton = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const setTheme = (isDark) => {
            if (isDark) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                if (lightIcon && darkIcon) {
                    lightIcon.classList.remove('hidden');
                    darkIcon.classList.add('hidden');
                }
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                if (lightIcon && darkIcon) {
                    darkIcon.classList.remove('hidden');
                    lightIcon.classList.add('hidden');
                }
            }
        };

        const isCurrentlyDark = document.documentElement.classList.contains('dark');
        setTheme(isCurrentlyDark);

        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', () => {
                setTheme(!document.documentElement.classList.contains('dark'));
            });
        }
    </script>
</body>
</html>
